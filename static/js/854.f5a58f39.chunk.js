(()=>{"use strict";var e={854:(e,t,a)=>{var s=a(45),o=a(178),n=a.n(o),r=a(423),c=a.n(r),i=a(382);class d{constructor(){this.currentId=0,this.worker=void 0,this.onMessages={},this.worker=new Worker(new URL(a.p+a.u(151),a.b)),this.worker.onerror=e=>console.log("Worker error: ",e),this.worker.onmessage=e=>{const{id:t}=e.data,a=this.onMessages[t];if(null==a)throw console.error("invalid message id",t,e),new Error("invalid message id => ".concat(t));a(e),delete this.onMessages[t]}}async exec(e,t){const a="exec-".concat(this.currentId++);return new Promise(((s,o)=>{this.onMessages[a]=e=>{console.debug("DatabaseConnector.onmessage",e.data.id,a,e),e.data.id===a&&(e.data.error?o(e.data):s(e.data.results))},console.debug("DatabaseConnector.sending","exec",a,e,t),this.worker.postMessage({id:a,action:"exec",sql:e,params:t})}))}async export(){const e="export-".concat(this.currentId++);return new Promise(((t,a)=>{this.onMessages[e]=s=>{console.debug("DatabaseConnector.onmessage",s.data.id,e,s),s.data.id===e&&(s.data.error?a(s.data):t(s.data.buffer))},console.debug("DatabaseConnector.sending","export",e),this.worker.postMessage({id:e,action:"export"})}))}async open(e){const t="open-".concat(this.currentId++);return new Promise(((a,s)=>{this.onMessages[t]=e=>{console.debug("DatabaseConnector.onmessage",e.data.id,t,e),e.data.id===t&&(e.data.error?s(e.data):a(e.data))},console.debug("DatabaseConnector.sending","open",t),this.worker.postMessage({id:t,action:"open",buffer:e})}))}}const l="base64";class u{static async create(e){const t=await u.exportLocalDump();null==e&&null!=t&&(e=i.hp.from(t,l));const a=new d;await a.open(e);const s=new m(a);return await s.runMigrations(),s}static async persistLocalDump(e){await c().setItem(u.DB_NAME,e||"")}static async exportLocalDump(){return await c().getItem(u.DB_NAME)}static generateDumpFromExport(e){return i.hp.from(e).toString(l)}}u.DB_NAME="gestao-trade.settings.db";let h=function(e){return e[e.DATE=0]="DATE",e[e.DATE_TIME=1]="DATE_TIME",e[e.NUMBER=2]="NUMBER",e[e.BOOLEAN=3]="BOOLEAN",e[e.IGNORE=4]="IGNORE",e}({}),E=function(e){return e.ACOES="acoes",e.HISTORICO_ACOES="historico_acoes",e.PARAMETROS="parametros",e}({});const p="runned";class m{constructor(e){this.db=e,this.DEFAULT_MAPPING={createdDate:h.DATE_TIME,updatedDate:h.DATE_TIME,monthYear:h.IGNORE}}async saveAll(e,t){const a=["BEGIN TRANSACTION"];let s={};console.debug("saveAll:start");for(let n=0;n<t.length;n++){const o=t[n];let r={};r=null==o.id?this.createInsertCommand(e,o,"".concat(n)):this.createUpdateCommand(e,o,"".concat(n));const{command:c,params:i}=r;a.push(c),s=Object.assign(s,i)}a.push("COMMIT");const o=a.join(";");console.debug("saveAll:parse:ok"),await this.db.exec(o,s),console.debug("saveAll:exec:ok"),await this.persistDb(),console.debug("saveAll:persist:ok"),console.debug("saveAll:end")}async save(e,t){let a={};return a=null!=(null===t||void 0===t?void 0:t.id)?await this.update(e,t):await this.insert(e,t),await this.persistDb(),a}async delete(e,t){return await this.db.exec("delete from ".concat(e," where id = $id"),{$id:t}),await this.persistDb(),{}}async list(e){const t=await this.db.exec("SELECT * FROM ".concat(e," order by createdDate desc"));if(!Array.isArray(t))throw new Error("".concat(e," n\xe3o encontrado (a)"));return this.parseSqlResultToObj(t,this.DEFAULT_MAPPING)[0]||[]}async get(e,t){const a=await this.db.exec("select * from ".concat(e," where id = $id"),{$id:t});if(0===a.length)throw new Error("".concat(e," n\xe3o encontrado (a)"));return this.parseSqlResultToObj(a,this.DEFAULT_MAPPING)[0][0]}async insert(e,t){const{command:a,params:s,nextData:o}=this.createInsertCommand(e,t),n="".concat(a,";SELECT LAST_INSERT_ROWID();"),r=await this.db.exec(n,s);return o.id=r[0].values[0][0],o}createInsertCommand(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const s={...t,createdDate:new Date},{keys:o,params:n}=this.parseToCommand(s,a),r="(".concat(o.map((e=>"$".concat(e).concat(a))).join(", "),")");return{command:"INSERT INTO ".concat(e," (").concat(o.join(", "),") VALUES ").concat(r),params:n,nextData:s,valuesCommand:r}}async update(e,t){const{command:a,params:s}=this.createUpdateCommand(e,t);return await this.db.exec(a,s),this.get(e,t.id)}createUpdateCommand(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const s={...t,updatedDate:new Date},{keys:o,params:n}=this.parseToCommand(s,a);return{command:"UPDATE ".concat(e," SET ").concat(o.map((e=>"".concat(e,"=$").concat(e).concat(a))).join(", ")," WHERE id=$id").concat(a),params:n,nextData:s}}parseSqlResultToObj(e,t){return e.map((e=>e.values.map((a=>e.columns.reduce(((e,o,r)=>{const c=a[r];let i=!0;return"id"!==o&&null!=c&&(null!=t&&(t[o]===h.DATE?(e[o]=n()(c,"YYYY-MM-DD").toDate(),i=!1):t[o]===h.DATE_TIME?(e[o]=n()(c,"YYYY-MM-DD hh:mm:ss").toDate(),i=!1):t[o]===h.NUMBER?(e[o]=c,i=!1):t[o]===h.BOOLEAN?(e[o]=!!c,i=!1):t[o]===h.IGNORE&&(i=!1)),i&&"number"===typeof c&&(e[o]=(0,s.A)(c),i=!1)),i&&(e[o]=c),e}),{})))))}parseToCommand(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const a=Object.keys(e).filter((t=>void 0!==e[t])),s=a.reduce(((a,s)=>{var o,r;let c=null!==(o=e[s])&&void 0!==o?o:null;return c instanceof Date&&(c=n()(c).format()),null!==(r=c)&&void 0!==r&&r._isBigNumber&&(c=c.toNumber()),a["$".concat(s).concat(t)]=c,a}),{});return{keys:a,params:s}}async runMigrations(){await Promise.resolve(),await this.db.exec('CREATE TABLE IF NOT EXISTS "migrations" ("id" INTEGER NOT NULL,"name" TEXT NULL DEFAULT NULL,"executedDate" DATETIME NULL,PRIMARY KEY ("id"));');const e=await this.db.exec('select * from "migrations"'),t=(this.parseSqlResultToObj(e)[0]||[]).reduce(((e,t)=>(e[t.name]=t,e)),{});null==t.parametros&&(await this.db.exec('CREATE TABLE IF NOT EXISTS "parametros" ("id" INTEGER NOT NULL,"chave" TEXT NOT NULL,"valor" TEXT NULL, "createdDate" DATETIME NOT NULL, "updatedDate" DATETIME NULL DEFAULT NULL,PRIMARY KEY ("id"));'),t.parametros=p),null==t.acoes&&(await this.db.exec('CREATE TABLE IF NOT EXISTS "acoes" ("id" INTEGER NOT NULL,"nome" TEXT NOT NULL,"logo" TEXT NULL,"codigo" TEXT NULL, "tipo" INTEGER NULL, "active" INTEGER NULL, "valorDeMercado" REAL NULL, "setor" TEXT NULL, "createdDate" DATETIME NOT NULL, "updatedDate" DATETIME NULL DEFAULT NULL,PRIMARY KEY ("id"));'),t.acoes=p),null==t.desativar_acoes&&(await this.db.exec('UPDATE acoes SET "active" = 0 WHERE 1 = 1;'),t.desativar_acoes=p),null==t.historico_acoes&&(await this.db.exec('DROP TABLE IF EXISTS "historico_acoes"'),await this.db.exec('CREATE TABLE IF NOT EXISTS "historico_acoes" ("id" INTEGER NOT NULL,"codigo" TEXT NOT NULL,"date" DATETIME NOT NULL,"open" REAL NULL,"high" REAL NULL,"low" REAL NULL,"close" REAL NULL,"adjustedClose" REAL NULL,"volume" REAL NULL,"intervalo" TEXT NOT NULL, "createdDate" DATETIME NOT NULL, "updatedDate" DATETIME NULL DEFAULT NULL,PRIMARY KEY ("id"));'),t.historico_acoes=p);const a=Object.keys(t).filter((e=>t[e]===p)).reduce(((e,t)=>(e.push({name:t,executedDate:new Date}),e)),[]);let s={},o="";a.length>0&&(a.forEach(((e,t)=>{const{keys:a,params:n}=this.parseToCommand(e,"".concat(t)),r='INSERT INTO "migrations" ('.concat(a.join(", "),") VALUES (").concat(a.map((e=>"$".concat(e).concat(t))).join(", "),")");o="".concat(o,";").concat(r),s={...s,...n}})),await this.db.exec(o,s)),await this.persistDb()}async exportOriginalDump(){return await this.db.export()}async persistDb(){const e=await this.exportDump();await u.persistLocalDump(e),console.debug("persistDb ok")}async exportDump(){await Promise.resolve();const e=await this.db.export();return await u.generateDumpFromExport(e)}beforeClose(){window.addEventListener("beforeunload",(e=>{const t="Ter certeza que deseja sair?",a=e||window.event;return a&&(a.returnValue=t),this.persistDb(),t}))}}let T=function(e){return e[e.COMPANY=1]="COMPANY",e[e.FII=2]="FII",e[e.ETFS=3]="ETFS",e[e.OTHERS=4]="OTHERS",e}({});let g=function(e){return e.LOAD_ALL="loadAll",e.CONNECT="connect",e}({});const L=crypto.randomUUID(),b="gestao-database-channel-send-".concat(L),A="gestao-database-channel-receive-".concat(L);const w="BRAPI_API_KEY";console.debug("brapi-worker start");const D="BRAPI_LAST_UPDATE",N=new class{constructor(e){this.broadcastSend=new BroadcastChannel(b),this.broadcastReceive=new BroadcastChannel(A),this.broadcastConnect=new BroadcastChannel("DB_BROADCAST_CHANNEL_SW"),this.onMessages=[],this.onExecMessages={},this.workerName=void 0,this.currentId=0,this.workerName="sw-".concat(e),this.broadcastReceive.onmessage=e=>{const{id:t}=e.data,a=this.onExecMessages[t];if(null==a)throw console.debug("invalid message id",t,e),new Error("invalid message id => ".concat(t," (pode ser que voc\xea esteja com outra tab aberta)"));a(e),delete this.onExecMessages[t]},this.broadcastReceive.onmessageerror=e=>{console.error("WorkerDatabaseConnector.onmessageerror",e)},this.broadcastConnect.postMessage({id:"connect",swName:this.workerName,sendChannel:b,receiveChannel:A})}setOnMessage(e){this.onMessages.push(e)}postReceive(e){this.broadcastReceive.postMessage(e.data)}async exec(e,t){const a="".concat(this.workerName,":exec-").concat(this.currentId++);return new Promise(((s,o)=>{this.onExecMessages[a]=e=>{console.debug("WorkerDatabaseConnector.onmessage",e.data.id,a,e),e.data.id===a&&(e.data.error?o(e.data):s(e.data.results))},console.debug("WorkerDatabaseConnector.sending","exec",a,e,t),this.broadcastSend.postMessage({id:a,action:"exec",sql:e,params:t})}))}async export(){const e="".concat(this.workerName,":export-").concat(this.currentId++);return new Promise(((t,a)=>{this.onExecMessages[e]=s=>{console.debug("WorkerDatabaseConnector.onmessage",s.data.id,e,s),s.data.id===e&&(s.data.error?a(s.data):t(s.data.buffer))},console.debug("WorkerDatabaseConnector.sending","export",e),this.broadcastSend.postMessage({id:e,action:"export"})}))}async open(e){throw new Error("Method not implemented.")}}("brapi"),v=new class extends m{constructor(){super(...arguments),this.ACOES_MAPPING={...this.DEFAULT_MAPPING,tipo:h.NUMBER,active:h.BOOLEAN}}async marcarComoAtivos(e){for(let t=0;t<e.length;t++){const a=e[t];a.active=!a.active}await this.saveAll(E.ACOES,e)}async listPaginado(e,t,a){var o;const n=await this.db.exec('\n    SELECT count(1) as total\n    FROM acoes a\n    WHERE $search is NULL    \n      OR a.codigo LIKE $search\n      OR a.nome LIKE $search\n      OR a.setor LIKE $search;\n      \n    SELECT *\n    FROM acoes a\n    WHERE $search is NULL    \n        OR a.codigo LIKE $search\n        OR a.nome LIKE $search\n        OR a.setor LIKE $search\n    ORDER BY a."active" desc\n    LIMIT $limit OFFSET $offset;\n    ',{$search:null==e?null:"%".concat(e,"%"),$offset:(t-1)*a,$limit:a}),r=this.parseSqlResultToObj(n,this.ACOES_MAPPING);return{total:(0,s.A)(null===(o=r[0][0])||void 0===o?void 0:o.total).toNumber(),acoes:r[1]||[]}}async listActives(){const e=await this.db.exec('      \n    SELECT *\n    FROM acoes a\n    WHERE a."active" = 1\n    ');return this.parseSqlResultToObj(e,this.ACOES_MAPPING)[0]||[]}}(N),O=new class extends m{constructor(){super(...arguments),this._paramsDict=void 0}async getDict(){return null==this._paramsDict&&(this._paramsDict=await this.loadParamsOrDefault()),this._paramsDict}async loadParamsOrDefault(){const e=(await this.list(E.PARAMETROS)).reduce(((e,t)=>(e[t.chave]=t,e)),{}),t=e;t[w]=e[w]||{chave:w,valor:""};const a=Object.keys(t).map((e=>t[e])).filter((e=>null==e.id));return await Promise.all(a.map((e=>this.save(E.PARAMETROS,e)))),t}async getByKey(e){return(await this.getDict())[e]}async getValorByKey(e){var t;return null===(t=(await this.getDict())[e])||void 0===t?void 0:t.valor}async set(e,t){let a=(await this.getDict())[e];null==a&&(a={});const s=await this.save(E.PARAMETROS,{...a,chave:e,valor:t});return delete this._paramsDict,s}}(N);self.onmessage=e=>{if(console.debug("brapi.onmessage",e),e.data.action===g.LOAD_ALL)!async function(e){const t=await O.getByKey(D),a=n()(null===t||void 0===t?void 0:t.valor),o=n()(new Date).add(-14,"days").isSameOrAfter(a);null==t||o?(console.debug("calling brapi"),await async function(){const e=await fetch("https://brapi.dev/api/quote/list"),{stocks:t}=await e.json(),a=t.map((e=>({nome:e.name,codigo:e.stock,tipo:null!=e.sector?T.COMPANY:T.OTHERS,active:!0,valorDeMercado:new s.A(e.market_cap),logo:e.logo,setor:e.sector}))),o=[],n=function(e){return e.reduce(((e,t)=>(e[t.codigo]=t,e)),{})}(await v.list(E.ACOES));for(let s=0;s<a.length;s++){const e=a[s],t=n[e.codigo],r=t||{};r.active=e.active,r.codigo=e.codigo,r.logo=e.logo,r.nome=e.nome,r.setor=e.setor,r.tipo=e.tipo,r.valorDeMercado=e.valorDeMercado,null==t&&(r.active=!1),o.push(r)}return await v.saveAll(E.ACOES,o),a}(),await O.set(D,n()(new Date).toISOString()),console.debug("end calling brapi")):console.debug("not needed to call brapi;");self.postMessage({id:e.id,response:{success:!0}})}(e.data)},console.debug("brapi-worker end")}},t={};function a(s){var o=t[s];if(void 0!==o)return o.exports;var n=t[s]={id:s,loaded:!1,exports:{}};return e[s].call(n.exports,n,n.exports,a),n.loaded=!0,n.exports}a.m=e,a.x=()=>{var e=a.O(void 0,[105],(()=>a(854)));return e=a.O(e)},(()=>{var e=[];a.O=(t,s,o,n)=>{if(!s){var r=1/0;for(l=0;l<e.length;l++){s=e[l][0],o=e[l][1],n=e[l][2];for(var c=!0,i=0;i<s.length;i++)(!1&n||r>=n)&&Object.keys(a.O).every((e=>a.O[e](s[i])))?s.splice(i--,1):(c=!1,n<r&&(r=n));if(c){e.splice(l--,1);var d=o();void 0!==d&&(t=d)}}return t}n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[s,o,n]}})(),a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,s)=>(a.f[s](e,t),t)),[])),a.u=e=>"static/js/"+e+"."+{105:"093ee82a",151:"d3f9119b"}[e]+".chunk.js",a.miniCssF=e=>{},a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),a.p="/gestao-trade/",(()=>{a.b=self.location+"/../../../";var e={854:1};a.f.i=(t,s)=>{e[t]||importScripts(a.p+a.u(t))};var t=self.webpackChunkgestao_trade=self.webpackChunkgestao_trade||[],s=t.push.bind(t);t.push=t=>{var o=t[0],n=t[1],r=t[2];for(var c in n)a.o(n,c)&&(a.m[c]=n[c]);for(r&&r(a);o.length;)e[o.pop()]=1;s(t)}})(),(()=>{var e=a.x;a.x=()=>a.e(105).then(e)})();a.x()})();
//# sourceMappingURL=854.f5a58f39.chunk.js.map