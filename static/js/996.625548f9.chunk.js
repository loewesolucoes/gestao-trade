(()=>{"use strict";var e={996:(e,a,t)=>{let o=function(e){return e.LOAD_ALL="loadAll",e.CONNECT="connect",e}({});const s=crypto.randomUUID(),n="gestao-database-channel-send-".concat(s),r="gestao-database-channel-receive-".concat(s);var c=t(45),i=t(178),d=t.n(i),l=t(423),u=t.n(l),h=t(382);class E{constructor(){this.currentId=0,this.worker=void 0,this.onMessages={},this.worker=new Worker(new URL(t.p+t.u(151),t.b)),this.worker.onerror=e=>console.log("Worker error: ",e),this.worker.onmessage=e=>{const{id:a}=e.data,t=this.onMessages[a];if(null==t)throw console.error("invalid message id",a,e),new Error("invalid message id => ".concat(a));t(e),delete this.onMessages[a]}}async exec(e,a){const t="exec-".concat(this.currentId++);return new Promise(((o,s)=>{this.onMessages[t]=e=>{console.debug("DatabaseConnector.onmessage",e.data.id,t,e),e.data.id===t&&(e.data.error?s(e.data):o(e.data.results))},console.debug("DatabaseConnector.sending","exec",t,e,a),this.worker.postMessage({id:t,action:"exec",sql:e,params:a})}))}async export(){const e="export-".concat(this.currentId++);return new Promise(((a,t)=>{this.onMessages[e]=o=>{console.debug("DatabaseConnector.onmessage",o.data.id,e,o),o.data.id===e&&(o.data.error?t(o.data):a(o.data.buffer))},console.debug("DatabaseConnector.sending","export",e),this.worker.postMessage({id:e,action:"export"})}))}async open(e){const a="open-".concat(this.currentId++);return new Promise(((t,o)=>{this.onMessages[a]=e=>{console.debug("DatabaseConnector.onmessage",e.data.id,a,e),e.data.id===a&&(e.data.error?o(e.data):t(e.data))},console.debug("DatabaseConnector.sending","open",a),this.worker.postMessage({id:a,action:"open",buffer:e})}))}}const p="base64";class g{static async create(e){const a=await g.exportLocalDump();null==e&&null!=a&&(e=h.hp.from(a,p));const t=new E;await t.open(e);const o=new b(t);return await o.runMigrations(),o}static async persistLocalDump(e){await u().setItem(g.DB_NAME,e||"")}static async exportLocalDump(){return await u().getItem(g.DB_NAME)}static generateDumpFromExport(e){return h.hp.from(e).toString(p)}}g.DB_NAME="gestao-trade.settings.db";let m=function(e){return e[e.DATE=0]="DATE",e[e.DATE_TIME=1]="DATE_TIME",e[e.NUMBER=2]="NUMBER",e[e.BOOLEAN=3]="BOOLEAN",e[e.IGNORE=4]="IGNORE",e}({}),T=function(e){return e.ACOES="acoes",e.HISTORICO_ACOES="historico_acoes",e.PARAMETROS="parametros",e}({});const A="runned";class b{constructor(e){this.db=e,this.DEFAULT_MAPPING={createdDate:m.DATE_TIME,updatedDate:m.DATE_TIME,monthYear:m.IGNORE}}async saveAll(e,a){const t=["BEGIN TRANSACTION"];let o={};console.debug("saveAll:start");for(let n=0;n<a.length;n++){const s=a[n];let r={};r=null==s.id?this.createInsertCommand(e,s,"".concat(n)):this.createUpdateCommand(e,s,"".concat(n));const{command:c,params:i}=r;t.push(c),o=Object.assign(o,i)}t.push("COMMIT");const s=t.join(";");console.debug("saveAll:parse:ok"),await this.db.exec(s,o),console.debug("saveAll:exec:ok"),await this.persistDb(),console.debug("saveAll:persist:ok"),console.debug("saveAll:end")}async save(e,a){let t={};return t=null!=(null===a||void 0===a?void 0:a.id)?await this.update(e,a):await this.insert(e,a),await this.persistDb(),t}async delete(e,a){return await this.db.exec("delete from ".concat(e," where id = $id"),{$id:a}),await this.persistDb(),{}}async list(e){const a=await this.db.exec("SELECT * FROM ".concat(e," order by createdDate desc"));if(!Array.isArray(a))throw new Error("".concat(e," n\xe3o encontrado (a)"));return this.parseSqlResultToObj(a,this.DEFAULT_MAPPING)[0]||[]}async get(e,a){const t=await this.db.exec("select * from ".concat(e," where id = $id"),{$id:a});if(0===t.length)throw new Error("".concat(e," n\xe3o encontrado (a)"));return this.parseSqlResultToObj(t,this.DEFAULT_MAPPING)[0][0]}async insert(e,a){const{command:t,params:o,nextData:s}=this.createInsertCommand(e,a),n="".concat(t,";SELECT LAST_INSERT_ROWID();"),r=await this.db.exec(n,o);return s.id=r[0].values[0][0],s}createInsertCommand(e,a){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const o={...a,createdDate:new Date},{keys:s,params:n}=this.parseToCommand(o,t),r="(".concat(s.map((e=>"$".concat(e).concat(t))).join(", "),")");return{command:"INSERT INTO ".concat(e," (").concat(s.join(", "),") VALUES ").concat(r),params:n,nextData:o,valuesCommand:r}}async update(e,a){const{command:t,params:o}=this.createUpdateCommand(e,a);return await this.db.exec(t,o),this.get(e,a.id)}createUpdateCommand(e,a){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const o={...a,updatedDate:new Date},{keys:s,params:n}=this.parseToCommand(o,t);return{command:"UPDATE ".concat(e," SET ").concat(s.map((e=>"".concat(e,"=$").concat(e).concat(t))).join(", ")," WHERE id=$id").concat(t),params:n,nextData:o}}parseSqlResultToObj(e,a){return e.map((e=>e.values.map((t=>e.columns.reduce(((e,o,s)=>{const n=t[s];let r=!0;return"id"!==o&&null!=n&&(null!=a&&(a[o]===m.DATE?(e[o]=d()(n,"YYYY-MM-DD").toDate(),r=!1):a[o]===m.DATE_TIME?(e[o]=d()(n,"YYYY-MM-DD hh:mm:ss").toDate(),r=!1):a[o]===m.NUMBER?(e[o]=n,r=!1):a[o]===m.BOOLEAN?(e[o]=!!n,r=!1):a[o]===m.IGNORE&&(r=!1)),r&&"number"===typeof n&&(e[o]=(0,c.A)(n),r=!1)),r&&(e[o]=n),e}),{})))))}parseToCommand(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const t=Object.keys(e).filter((a=>void 0!==e[a])),o=t.reduce(((t,o)=>{var s,n;let r=null!==(s=e[o])&&void 0!==s?s:null;return r instanceof Date&&(r=d()(r).format()),null!==(n=r)&&void 0!==n&&n._isBigNumber&&(r=r.toNumber()),t["$".concat(o).concat(a)]=r,t}),{});return{keys:t,params:o}}async runMigrations(){await Promise.resolve(),await this.db.exec('CREATE TABLE IF NOT EXISTS "migrations" ("id" INTEGER NOT NULL,"name" TEXT NULL DEFAULT NULL,"executedDate" DATETIME NULL,PRIMARY KEY ("id"));');const e=await this.db.exec('select * from "migrations"'),a=(this.parseSqlResultToObj(e)[0]||[]).reduce(((e,a)=>(e[a.name]=a,e)),{});null==a.parametros&&(await this.db.exec('CREATE TABLE IF NOT EXISTS "parametros" ("id" INTEGER NOT NULL,"chave" TEXT NOT NULL,"valor" TEXT NULL, "createdDate" DATETIME NOT NULL, "updatedDate" DATETIME NULL DEFAULT NULL,PRIMARY KEY ("id"));'),a.parametros=A),null==a.acoes&&(await this.db.exec('CREATE TABLE IF NOT EXISTS "acoes" ("id" INTEGER NOT NULL,"nome" TEXT NOT NULL,"logo" TEXT NULL,"codigo" TEXT NULL, "tipo" INTEGER NULL, "active" INTEGER NULL, "valorDeMercado" REAL NULL, "setor" TEXT NULL, "createdDate" DATETIME NOT NULL, "updatedDate" DATETIME NULL DEFAULT NULL,PRIMARY KEY ("id"));'),a.acoes=A),null==a.desativar_acoes&&(await this.db.exec('UPDATE acoes SET "active" = 0 WHERE 1 = 1;'),a.desativar_acoes=A),null==a.historico_acoes&&(await this.db.exec('DROP TABLE IF EXISTS "historico_acoes"'),await this.db.exec('CREATE TABLE IF NOT EXISTS "historico_acoes" ("id" INTEGER NOT NULL,"codigo" TEXT NOT NULL,"date" DATETIME NOT NULL,"open" REAL NULL,"high" REAL NULL,"low" REAL NULL,"close" REAL NULL,"adjustedClose" REAL NULL,"volume" REAL NULL,"intervalo" TEXT NOT NULL, "createdDate" DATETIME NOT NULL, "updatedDate" DATETIME NULL DEFAULT NULL,PRIMARY KEY ("id"));'),a.historico_acoes=A);const t=Object.keys(a).filter((e=>a[e]===A)).reduce(((e,a)=>(e.push({name:a,executedDate:new Date}),e)),[]);let o={},s="";t.length>0&&(t.forEach(((e,a)=>{const{keys:t,params:n}=this.parseToCommand(e,"".concat(a)),r='INSERT INTO "migrations" ('.concat(t.join(", "),") VALUES (").concat(t.map((e=>"$".concat(e).concat(a))).join(", "),")");s="".concat(s,";").concat(r),o={...o,...n}})),await this.db.exec(s,o)),await this.persistDb()}async exportOriginalDump(){return await this.db.export()}async persistDb(){const e=await this.exportDump();await g.persistLocalDump(e),console.debug("persistDb ok")}async exportDump(){await Promise.resolve();const e=await this.db.export();return await g.generateDumpFromExport(e)}beforeClose(){window.addEventListener("beforeunload",(e=>{const a="Ter certeza que deseja sair?",t=e||window.event;return t&&(t.returnValue=a),this.persistDb(),a}))}}const D="BRAPI_API_KEY";let L=function(e){return e.UM_MINUTO="1m",e.CINCO_MINUTOS="5m",e.UM_DIA="1d",e}({});var N;class w{static send(e){w.broadcast.postMessage({message:e})}}N=w,w.TIME_TO_CLOSE_NOTIFICATION=1e4,w.NOTIFICATION_BROADCAST_CHANNEL_KEY="NOTIFICATION_BROADCAST_CHANNEL_KEY",w.broadcast=new BroadcastChannel(N.NOTIFICATION_BROADCAST_CHANNEL_KEY),console.debug("yahoo-worker start");const v=new class{constructor(e){this.broadcastSend=new BroadcastChannel(n),this.broadcastReceive=new BroadcastChannel(r),this.broadcastConnect=new BroadcastChannel("DB_BROADCAST_CHANNEL_SW"),this.onMessages=[],this.onExecMessages={},this.workerName=void 0,this.currentId=0,this.workerName="sw-".concat(e),this.broadcastReceive.onmessage=e=>{const{id:a}=e.data,t=this.onExecMessages[a];if(null==t)throw console.debug("invalid message id",a,e),new Error("invalid message id => ".concat(a," (pode ser que voc\xea esteja com outra tab aberta)"));t(e),delete this.onExecMessages[a]},this.broadcastReceive.onmessageerror=e=>{console.error("WorkerDatabaseConnector.onmessageerror",e)},this.broadcastConnect.postMessage({id:"connect",swName:this.workerName,sendChannel:n,receiveChannel:r})}setOnMessage(e){this.onMessages.push(e)}postReceive(e){this.broadcastReceive.postMessage(e.data)}async exec(e,a){const t="".concat(this.workerName,":exec-").concat(this.currentId++);return new Promise(((o,s)=>{this.onExecMessages[t]=e=>{console.debug("WorkerDatabaseConnector.onmessage",e.data.id,t,e),e.data.id===t&&(e.data.error?s(e.data):o(e.data.results))},console.debug("WorkerDatabaseConnector.sending","exec",t,e,a),this.broadcastSend.postMessage({id:t,action:"exec",sql:e,params:a})}))}async export(){const e="".concat(this.workerName,":export-").concat(this.currentId++);return new Promise(((a,t)=>{this.onExecMessages[e]=o=>{console.debug("WorkerDatabaseConnector.onmessage",o.data.id,e,o),o.data.id===e&&(o.data.error?t(o.data):a(o.data.buffer))},console.debug("WorkerDatabaseConnector.sending","export",e),this.broadcastSend.postMessage({id:e,action:"export"})}))}async open(e){throw new Error("Method not implemented.")}}("yahoo"),O=new class extends b{constructor(){super(...arguments),this.HISTORICO_ACOES_MAPPING={...this.DEFAULT_MAPPING}}async listByCode(e){const a=await this.db.exec('\n    SELECT *\n    FROM historico_acoes h\n    WHERE h."codigo" = $codigo\n    GROUP BY h."codigo", h."date"\n    ORDER BY h."date" asc;\n    ',{$codigo:e});return this.parseSqlResultToObj(a,this.HISTORICO_ACOES_MAPPING)[0]||[]}async ultimasAtualizacoesEAtivos(e){const a=await this.db.exec('\n    SELECT *\n    FROM acoes a\n    WHERE a."active" = 1;\n\n    SELECT h.*, MAX(h.date) AS date\n    FROM acoes a\n    JOIN historico_acoes h\n      ON a.codigo = h.codigo\n    WHERE a."active" = 1\n      AND h."intervalo" = $intervalo\n    GROUP BY h.codigo;\n    ',{$intervalo:e}),t=this.parseSqlResultToObj(a,this.HISTORICO_ACOES_MAPPING);return{ativos:t[0]||[],ultimasAtualizacoes:t[1]||[]}}async acoesQuePrecisamAtualizar(e){const a=d()(new Date).add(-1,"day"),{ultimasAtualizacoes:t,ativos:o}=await this.ultimasAtualizacoesEAtivos(e);console.debug("ultimasAtualizacoesEAtivos",t,o);const s=t.reduce(((e,a)=>(e[a.codigo]=a,e)),{});return o.map((t=>{const o=s[t.codigo],n={periodStart:d()("1900-01-01","YYYY-MM-DD"),periodEnd:d()(new Date).add(1,"day"),codigoAcao:t.codigo,logoAcao:t.logo,idAcao:t.id,intervalo:e};return null!=o&&(n.periodStart=d()(o.createdDate).add(-1,"day"),n.periodStart.isSame(a,"day")&&(n.codigoAcao=void 0)),n})).filter((e=>null!=e.codigoAcao))}}(v);new class extends b{constructor(){super(...arguments),this._paramsDict=void 0}async getDict(){return null==this._paramsDict&&(this._paramsDict=await this.loadParamsOrDefault()),this._paramsDict}async loadParamsOrDefault(){const e=(await this.list(T.PARAMETROS)).reduce(((e,a)=>(e[a.chave]=a,e)),{}),a=e;a[D]=e[D]||{chave:D,valor:""};const t=Object.keys(a).map((e=>a[e])).filter((e=>null==e.id));return await Promise.all(t.map((e=>this.save(T.PARAMETROS,e)))),a}async getByKey(e){return(await this.getDict())[e]}async getValorByKey(e){var a;return null===(a=(await this.getDict())[e])||void 0===a?void 0:a.valor}async set(e,a){let t=(await this.getDict())[e];null==t&&(t={});const o=await this.save(T.PARAMETROS,{...t,chave:e,valor:a});return delete this._paramsDict,o}}(v);async function I(e){const{codigoAcao:a,periodEnd:t,periodStart:o,intervalo:s}=e||{};try{const e=await async function(e,a,t,o){const s=[];console.debug("downloadHistoricalDataAndParse start");try{const r=await fetch("https://query1.finance.yahoo.com/v7/finance/download/".concat(e,".SA?period1=").concat(a.unix(),"&period2=").concat(t.unix(),"&interval=").concat(o,"&events=history"));if(console.debug("yahoo:".concat(e," fetch done")),r.ok&&null!=(null===r||void 0===r?void 0:r.body)){console.debug("yahoo:".concat(e," fetch ok"));const a=(await r.text()).split("\n");console.debug("yahoo:".concat(e," parse fetch start"));for(let t=1;t<a.length;t++){const r=a[t],i=r.split(","),l={codigo:e};try{l.date=d()(i[0],"YYYY-MM-DD").toDate(),l.open=(0,c.A)(i[1]),l.high=(0,c.A)(i[2]),l.low=(0,c.A)(i[3]),l.close=(0,c.A)(i[4]),l.adjustedClose=(0,c.A)(i[5]),l.volume=(0,c.A)(i[6]),l.intervalo=o,s.push(l)}catch(n){console.error("Erro ao fazer parse da linha => ",t,r,n)}}console.debug("yahoo:".concat(e," parse fetch end"))}else console.error("Yahoo status error",r),w.send("Erro ao integrar com o servi\xe7o yahoo")}catch(n){console.error("Enable cors",n),w.send('Voc\xea esta sem conex\xe3o a internet ou precisa habilitar a extens\xe3o <a href="https://webextension.org/listing/access-control.html" target="_blank">Cors Unblock</a> para usar a aplica\xe7\xe3o')}return s}(a,o,t,s);e.length>0?(console.debug("yahoo:".concat(a," saveAll start")),await O.saveAll(T.HISTORICO_ACOES,e),console.debug("yahoo:".concat(a," saveAll ok"))):console.debug("not needed to save yahoo for: ".concat(a))}catch(n){console.error("Yahoo status error",e),w.send("Erro ao integrar com o servi\xe7o yahoo => ".concat(a))}}self.onmessage=e=>{if(console.debug("yahoo.onmessage",e),e.data.action===o.LOAD_ALL)!async function(e){const a=L.UM_DIA,t=await O.acoesQuePrecisamAtualizar(a);if(console.debug("check if need to call yahoo",t),t.length>0){console.debug("calling yahoo");for(let e=0;e<t.length;e++)await I(t[e]);console.debug("end calling yahoo")}else console.debug("not needed to call yahoo;");console.debug("loadAll:end"),self.postMessage({id:e.id,response:{success:!0}})}(e.data)},console.debug("yahoo-worker end")}},a={};function t(o){var s=a[o];if(void 0!==s)return s.exports;var n=a[o]={id:o,loaded:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}t.m=e,t.x=()=>{var e=t.O(void 0,[105],(()=>t(996)));return e=t.O(e)},(()=>{var e=[];t.O=(a,o,s,n)=>{if(!o){var r=1/0;for(l=0;l<e.length;l++){o=e[l][0],s=e[l][1],n=e[l][2];for(var c=!0,i=0;i<o.length;i++)(!1&n||r>=n)&&Object.keys(t.O).every((e=>t.O[e](o[i])))?o.splice(i--,1):(c=!1,n<r&&(r=n));if(c){e.splice(l--,1);var d=s();void 0!==d&&(a=d)}}return a}n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[o,s,n]}})(),t.n=e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return t.d(a,{a:a}),a},t.d=(e,a)=>{for(var o in a)t.o(a,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:a[o]})},t.f={},t.e=e=>Promise.all(Object.keys(t.f).reduce(((a,o)=>(t.f[o](e,a),a)),[])),t.u=e=>"static/js/"+e+"."+{105:"093ee82a",151:"d3f9119b"}[e]+".chunk.js",t.miniCssF=e=>{},t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),t.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),t.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),t.p="/gestao-trade/",(()=>{t.b=self.location+"/../../../";var e={996:1};t.f.i=(a,o)=>{e[a]||importScripts(t.p+t.u(a))};var a=self.webpackChunkgestao_trade=self.webpackChunkgestao_trade||[],o=a.push.bind(a);a.push=a=>{var s=a[0],n=a[1],r=a[2];for(var c in n)t.o(n,c)&&(t.m[c]=n[c]);for(r&&r(t);s.length;)e[s.pop()]=1;o(a)}})(),(()=>{var e=t.x;t.x=()=>t.e(105).then(e)})();t.x()})();
//# sourceMappingURL=996.625548f9.chunk.js.map